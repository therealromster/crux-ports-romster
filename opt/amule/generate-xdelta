#!/bin/sh

source Pkgfile
source /etc/pkgmk.conf

[ -z "$PKGMK_WORK_DIR" ] && PKGMK_WORK_DIR="$PWD/work"
[ -z "$PKGMK_SOURCE_DIR" ] && PKGMK_SOURCE_DIR="$PWD"

if [ -e "$PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta" ]; then
	echo 'You have the latist xdelta file.'
	exit
fi

if [ ! -e "$PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar.bz2" ]; then
	echo "Warning: missing old version '$sname-$OLD_VERSION.tar.bz2'."
	exit
fi

# needs to be moved after sigkill is recived clan up code
if [ -e "$PKGMK_WORK_DIR" ]; then
	rm -rf "$PKGMK_WORK_DIR"
fi

if [ ! -e "$PKGMK_WORK_DIR" ]; then
	mkdir -p "$PKGMK_WORK_DIR"
fi
###
cd "$PKGMK_WORK_DIR"

cp $PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar.bz2 .
cp $PKGMK_SOURCE_DIR/$sname-$version.tar.bz2 .

bzip2 -d $sname-$OLD_VERSION.tar.bz2
bzip2 -d $sname-$version.tar.bz2
xdelta delta $sname-$OLD_VERSION.tar $sname-$version.tar \
	$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta

cd - > /dev/null
###

# clean up
cleanup() {
	rm "$PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar"
	rm "$PKGMK_SOURCE_DIR/$sname-$version.tar"
	rm "$PKGMK_WORK_DIR/$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta"

	if [ -e "$PKGMK_WORK_DIR" ]; then
		rmdir "$PKGMK_WORK_DIR"
	fi
}

# End of file
