#!/bin/bash

source Pkgfile
source /etc/pkgmk.conf

[ -z "${PKGMK_WORK_DIR}" ] && PKGMK_WORK_DIR="$PWD/work"
[ -z "${PKGMK_SOURCE_DIR}" ] && PKGMK_SOURCE_DIR="$PWD"
[ -z "${sname}" ] && sname="$name"
[ -z "${EXT}" ] && EXT='.tar.lzma'

if [ -e "$PKGMK_SOURCE_DIR/$name-$version${EXT}" ]; then
	echo 'You have the latist source file.'
	exit
fi

if [ -n "`pkginfo -i | egrep '^xdelta '`" ]; then
	if [ -e "$PKGMK_SOURCE_DIR/$sname-${OLD_VERSION}${EXT}" ]; then

		if [ ! -e "$PKGMK_WORK_DIR" ]; then
			mkdir -p "$PKGMK_WORK_DIR"
		fi
		cd "$PKGMK_WORK_DIR"

		if [ ! -e "$PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta" ]; then
			wget ${diff[0]}/$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta --directory-prefix=$PKGMK_SOURCE_DIR
		fi

		cp $PKGMK_SOURCE_DIR/$sname-${OLD_VERSION}${EXT} .
		cp $PKGMK_SOURCE_DIR/$sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta .
		echo -n '[ 33%] Decompressing source, '
		case ${EXT} in
			.tar.gz) gzip -d "$sname-${OLD_VERSION}${EXT}" ;;
			.tar.bz2) bzip2 -d "$sname-${OLD_VERSION}${EXT}" ;;
			.tar.lzma) lzma -d "$sname-${OLD_VERSION}${EXT}" ;;
		esac
		echo 'done.'
		echo -n '[ 66%] Patching source, '
		xdelta patch $sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta
		rm $sname-$OLD_VERSION.tar
		mv $sname-$OLD_VERSION.tar-$sname-$version.tar.xdelta $PKGMK_SOURCE_DIR/
		echo 'done.'
		echo -n '[100%] Compressing patched source, '
		case ${EXT} in
			.tar.gz) gzip -9 "$sname-$version.tar" ;;
			.tar.bz2) bzip2 -9 "$sname-$version.tar" ;;
			.tar.lzma) lzma -9 "$sname-$version.tar" ;;
		esac
		echo 'done.'
		mv $sname-${version}${EXT} $PKGMK_SOURCE_DIR/
	else
		echo "'$sname-${OLD_VERSION}${EXT}' not found proceed to run Pkgfile."
		exit
	fi
else
	echo "Warning: 'xdelta' is not installed can not do a incremental update."
fi

# End of file
