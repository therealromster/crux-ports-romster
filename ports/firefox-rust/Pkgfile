# Description: The Mozilla Firefox browser
# URL: https://www.mozilla.com/firefox/
# Maintainer: Danny Rawlins, crux at romster dot me
# Depends on: alsa-lib autoconf-2.13 gtk gtk3 libidl nss rust unzip xorg-libxt yasm zip
# Optional: clang dbus-glib libevent libvpx

name=firefox-rust
version=59.0.2
release=1
source=(https://hg.mozilla.org/releases/mozilla-release/archive/239e434d6d2b8e1e2b697c3416d1e96d48fe98e5.tar.bz2
	firefox.desktop)

build() {
	cd mozilla-release-239e434d6d2b8e1e2b697c3416d1e96d48fe98e5

	# Put Rust objects on a diet to keep the linker from running
	# into memory issues
	export RUSTFLAGS="-Cdebuginfo=0"

	export MOZ_MAKE_FLAGS="-j ${JOBS-1}"

	OPTIONS="\
		--prefix=/usr \
		--enable-default-toolkit=cairo-gtk3 \
		--enable-gold \
		--enable-optimize="-O2" \
		--with-system-jpeg \
		--with-system-zlib \
		--with-system-png \
		--with-system-nspr \
		--with-system-nss \
		--enable-system-ffi \
		--enable-system-pixman \
		--enable-system-sqlite \
		--enable-alsa \
		--disable-pulseaudio \
		--with-pthreads \
		--enable-official-branding \
		--with-distribution-id=nu.crux \
		--enable-extensions=default,-gnomevfs \
		--disable-tests \
		--disable-debug \
		--disable-updater \
		--disable-crashreporter \
		--disable-necko-wifi \
		--disable-gconf"

	# Mozilla devs enforce using an objdir for building
	# https://developer.mozilla.org/en/Configuring_Build_Options#Building_with_an_objdir
	echo "mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/firefox-shared" >> .mozconfig

	# Stylo is the new CSS code, including the rust 'style'
	[ -f '/usr/bin/clang' ] || OPTIONS+=" --disable-stylo"

	[ -f '/usr/lib/pkgconfig/dbus-glib-1.pc' ] || OPTIONS+=" --disable-dbus"
	[ -f '/usr/lib/pkgconfig/libevent.pc' ] && OPTIONS+=" --enable-system-libevent"
	[ -f '/usr/lib/pkgconfig/vpx.pc' ] && OPTIONS+=" --enable-system-libvpx"

	for option in $OPTIONS; do echo "ac_add_options $option" >> .mozconfig; done

	./mach build
	DESTDIR=$PKG ./mach install

	install -d $PKG/usr/share/pixmaps
	ln -s /usr/lib/firefox/browser/chrome/icons/default/default48.png $PKG/usr/share/pixmaps/firefox_default48.png
	install -D -m 0644 $SRC/firefox.desktop $PKG/usr/share/applications/firefox.desktop
	# Remove crap
	rm $PKG/usr/lib/firefox/browser/features/{firefox@getpocket.com.xpi,webcompat@mozilla.org.xpi,aushelper@mozilla.org.xpi,screenshots@mozilla.org.xpi}
	rm $PKG/usr/lib/firefox/removed-files

	mkdir -p $PKG/etc/revdep.d
	echo "/usr/lib/firefox" > $PKG/etc/revdep.d/firefox-rust
}
