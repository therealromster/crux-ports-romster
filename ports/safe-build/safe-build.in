#!/usr/bin/env bash

# Script to test own ports under a fresh install chroot enviroment or using the official image.

init() {

   	mkdir -p \
        $SAFE_BUILD_DIR/var/lib/pkg/rejected \
        $SAFE_BUILD_DIR/usr/ports/{distfiles,packages,work}

    touch $SAFE_BUILD_DIR/var/lib/pkg/db
}

setup_system() {
    local p

    init

    echo 'Seting up environment type: current system.'
   	
    echo -n 'Installing toolchain'
	cd '/usr/ports/core'
    
	for p in $SAFE_BUILD_TOOLCHAIN; do
		cd $p
		. Pkgfile

		if [ ! -e "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
			pkgmk -f
		fi

		pkgadd -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
        ln  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
        echo -n '.'
		cd ..
	done
    echo ''

	echo -n 'Installing Core ports'
	for p in *; do
		if [ $p != "$(echo "$SAFE_BUILD_TOOLCHAIN" | grep --only-matching $p)" ]; then

			cd $p
			. Pkgfile

			if [ ! -e "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
				pkgmk -f
			fi

			pkgadd -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
            ln  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
            echo -n '.'
			cd ..
		fi
	done
    echo ''

    if [ "$SAFE_BUILD_OPT_PORTS" = 'yes' ]; then
        echo -n 'Installing Opt ports'
        cd '/usr/ports/'

        for p in opt/*; do
		    cd $p
		    . Pkgfile

		    if [ ! -e "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
		    	pkgmk -f
		    fi

	    	pkgadd -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
            ln  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
            echo -n '.'
		    cd ..
	    done
        echo ''
    fi
   
    install_additional_ports
}

setup_image() {

    local p

    init

   	echo 'Setting up environment type: CD image.'
    if [ -f "$SAFE_BUILD_CD_IMAGE.iso" ]; then
        mount -o loop "$SAFE_BUILD_CD_IMAGE.iso" "$SAFE_BUILD_CD_MOUNT"
    else
        echo "Can not find $SAFE_BUILD_CD_IMAGE.iso"
        exit 1
    fi
	
    ###########################################################################

	echo -n 'Installing core ports'
    cd "$SAFE_BUILD_CD_MOUNT/crux"

    for p in core/*; do
		pkgadd -r "$SAFE_BUILD_DIR" "$p"
        cp "$p" "$SAFE_BUILD_DIR/usr/ports/packages/"
        echo -n '.'
	done

    echo ''

    if [ "$SAFE_BUILD_CDIMAGE_PACKAGES_UPDATE_CORE" = 'yes' ]; then
       echo -n 'Updating available upto date packages for core'
       #cd /usr/ports/core
       cd '/usr/share/safe-build/packages'

    	for p in *; do
            if [ -f "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
    		    pkgadd -u -r "$SAFE_BUILD_DIR" "/usr/share/safe-build/packages/$p"
                echo -n '.'
            fi
    	done
        echo ''
    else
        cd "$SAFE_BUILD_CD_MOUNT/crux"
        #cp core/* "$SAFE_BUILD_DIR/usr/ports/packages/"
    fi

    ###########################################################################
    
    if [ "$SAFE_BUILD_CDIMAGE_PORTS_OPT" = 'yes' ]; then
        echo -n 'Installing opt ports'
        cd "$SAFE_BUILD_CD_MOUNT/crux"

        for p in opt/*; do
    		pkgadd -r "$SAFE_BUILD_DIR" "$p"
            echo -n '.'
    	done

        echo ''
        
        if [ "$SAFE_BUILD_CDIMAGE_PACKAGES_UPDATE_OPT" = 'yes' ]; then
            echo -n 'Installing available upto date packages for opt'
            cd '/usr/ports'

            for p in opt/*; do
		        cd $p
                if [ -f Pkgfile ]; then
		            . Pkgfile

                    if [ -f "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
		                #cp  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
                        pkgadd -u -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
                        echo -n '.'
                    fi
                fi
		        cd ..
            done
    
            echo ''
        else
            cd "$SAFE_BUILD_CD_MOUNT/crux"
            #cp opt/* "$SAFE_BUILD_DIR/usr/ports/packages/"
        fi
    fi

    ###########################################################################

    if [ "$SAFE_BUILD_CDIMAGE_PACKAGES_INSTALL_XORG" = 'yes' ]; then
       echo -n 'Installing available packages for xorg'
       cd '/usr/ports/xorg'

    	for p in *; do
    		cd $p
            if [ -f Pkgfile ]; then
                . Pkgfile
                
                if [ -f "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
                    #cp  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
                    pkgadd -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
                    echo -n '.'
                fi
            fi
	    	cd ..
    	done
        echo ''
    else
        cd "$SAFE_BUILD_CD_MOUNT/crux"
        #cp xorg/* "$SAFE_BUILD_DIR/usr/ports/packages/"
    fi

    ###########################################################################

#    echo -n 'Installing Core current source files'
#    ports -u core > /dev/null
#    echo -n '.'
#    prt-get cache
#    echo -n '.'
#    cd /usr/ports/core

#	for p in *; do
#		if [ $p != "$(echo "$SAFE_BUILD_TOOLCHAIN" | grep --only-matching $p)" ]; then
		
#            cd $p
#			. Pkgfile

#            for file in ${source[@]}; do
#                if [ -e "/usr/ports/distfiles/$file" ]; then
#				    ln "/usr/ports/distfiles/$file" "$SAFE_BUILD_DIR/usr/ports/distfiles/"
#		    	fi
#            done
#            echo -n '.'
#            cd ..
#		fi
#	done
#    echo ''

    umount "$SAFE_BUILD_CD_MOUNT"

    install_additional_ports
}

install_additional_ports() {
	if [ "$SAFE_BUILD_ADDITIONAL_PORTS" ]; then
        echo -n 'Installing additional ports'
        cd '/usr/ports/'

	    for p in $SAFE_BUILD_ADDITIONAL_PORTS; do
	        if [ -f $p/Pkgfile ]; then
                cd $p
                . Pkgfile

	        	if [ ! -e "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" ]; then
	        		pkgmk -f
	        	fi

	        	pkgadd -r "$SAFE_BUILD_DIR" "/usr/ports/packages/$name#$version-$release.pkg.tar.gz"
                #ln  "/usr/ports/packages/$name#$version-$release.pkg.tar.gz" "$SAFE_BUILD_DIR/usr/ports/packages/"
                echo -n '.'
	        	cd ..
            else
                echo ''
                echo -n "Warning $p/Pkgfile is missing, skiping."
            fi
    	done
        echo ''
    fi

    rest
}


rest() {
	# copy DNS settings
	cp /etc/resolv.conf "$SAFE_BUILD_DIR/etc/"

	# copy port settings
	#cp /etc/prt-get.conf "$SAFE_BUILD_DIR/etc/"

	# activate contrib ports and copy over existing repos
	sed -i \
		-e 's|# PKGMK_SOURCE_DIR="$PWD"|PKGMK_SOURCE_DIR="/usr/ports/distfiles"|' \
		-e 's|# PKGMK_PACKAGE_DIR="$PWD"|PKGMK_PACKAGE_DIR="/usr/ports/packages"|' \
			"$SAFE_BUILD_DIR/etc/pkgmk.conf"

	if [ -e "$SAFE_BUILD_DIR/etc/ports/contrib.rsync.inactive" ]; then
		mv $SAFE_BUILD_DIR/etc/ports/contrib.rsync.inactive $SAFE_BUILD_DIR/etc/ports/contrib.rsync
	fi

    echo -n 'Installing ports tree'
	#cp /etc/ports/{*.httpup,*.rsync} "$SAFE_BUILD_DIR/etc/ports/"
    #cp /etc/ports/{core,opt,contrib,contrib-old,xorg}.rsync "$SAFE_BUILD_DIR/etc/ports/"
    for p in $SAFE_BUILD_PORTS_TREE; do
        if [ -f "/etc/ports/$P.sync" ] && [ ! -f "$SAFE_BUILD_DIR/etc/ports/$P.sync" ]; then
           ln "/etc/ports/$P.sync" "$SAFE_BUILD_DIR/etc/ports/"
           echo -n '.'
        elif [ -f "/etc/ports/$P.httpup" ] && [ ! -f "$SAFE_BUILD_DIR/etc/ports/$P.httpup" ]; then
            ln "/etc/ports/$P.httpup" "$SAFE_BUILD_DIR/etc/ports/"
            echo -n '.'
        fi
    done    
    
    # copy files over so a 'ports -u' dosn't take so long to do
	cd '/usr/ports/'
    
    for repo in $SAFE_BUILD_PORTS_TREE; do
		if [ $repo	!= distfiles ] && [ $repo != packages ]; then
            cp -R $repo "$SAFE_BUILD_DIR/usr/ports/"
            echo -n '.'
		fi
	done
    echo ''
    
	echo -n 'Hardlinking source files'
	cd '/usr/ports/distfiles'

    for f in *; do
        if [ -f $f ]; then
            ln $f "$SAFE_BUILD_DIR/usr/ports/distfiles/"
            echo -n '.'
        fi
	done

    echo ''

    # install script to chroot
    cp "/usr/sbin/${SAFE_BUILD_COMMAND##*/}" "$SAFE_BUILD_DIR/usr/sbin/"

    #start_chroot
    restore_ports
}

start_chroot() {
   	echo 'Activate chroot!'
	cd "$SAFE_BUILD_DIR"
	mount -t proc proc "$SAFE_BUILD_DIR/proc"
	mount --bind /dev "$SAFE_BUILD_DIR/dev"
	mount -t devpts devpts "$SAFE_BUILD_DIR/dev/pts"
	chroot "$SAFE_BUILD_DIR" /bin/sh
}

shutdown_umount() {
   umount /dev/pts
   umount /dev
   umount /proc
   rm "$SAFE_BUILD_DIR/dev/console"
}

backup_ports() {
    local file

    echo -n 'Backing up ports'
    
    # backup built packages
    cd "$SAFE_BUILD_DIR/usr/ports/packages"

    if [ ! -d "$SAFE_BUILD_DIR/usr/ports/packages/$CRUX_VERSION" ]; then
        mkdir $CRUX_VERSION
    fi

    for file in *; do
        if [ ! -f "/usr/share/safe-build/packages/$CRUX_VERSION/$file" ]; then
            ln "$SAFE_BUILD_DIR/usr/ports/packages/$file" "/usr/share/safe-build/packages/$CRUX_VERSION/$file"
            echo -n '.'
        fi
    done

    # hardlink downloaded source files    
    cd "$SAFE_BUILD_DIR/usr/ports/distfiles"
    for file in *; do
        if [ ! -f "/usr/ports/distfiles/$file" ]; then
            ln "$SAFE_BUILD_DIR/usr/ports/distfiles/$file" "/usr/ports/distfiles/$file"
            echo -n '.'
        fi
    done
    
    echo ''
}

restore_ports() {
    local file=''
    echo 'Restoring backed up ports'
    cd "/usr/share/safe-build/packages/$CRUX_VERSION"

    for file in *; do
        if [ -f "/usr/share/safe-build/packages/$CRUX_VERSION/$file" ]; then
            ln "/usr/share/safe-build/packages/$CRUX_VERSION/$file" "$SAFE_BUILD_DIR/usr/ports/packages/$file"
            echo -n '.'
        fi
    done
    
    echo ''

    start_chroot
}

clean() {
    local FILE LIST PKG TOTAL COUNT LINE I REQUIRED RECOMENDED OPTIONAL 

    FILE='/tmp/.safe-build' #TODO make global
    REQUIRED=(`ls --color=never /usr/ports/core/ |xargs` safe-build) #TODO fix hard coded path
    RECOMENDED=(popt distcc prtverify fakeroot)
    OPTIONAL=()
    LIST=(${REQUIRED[@]} ${RECOMENDED[@]} ${OPTIONAL[@]})

    pkginfo -i |awk '{print $1}' > $FILE.clean
    for PKG in "${LIST[@]}"; do
       	sed -i -e "/^$PKG$/d" $FILE.clean
    done
    TOTAL=`cat $FILE.clean |wc -w`
    COUNT=1
    cat $FILE.clean |while read LINE; do
        I=`printf  "%.0f\n" $(bc -l <<< "($COUNT / $TOTAL) * 100")`
        if (( $I < 9 )); then
            echo "[$I%  ] Removing: $LINE"
        elif (( $I < 100 )); then
            echo "[$I% ] Removing: $LINE"
        else
            echo "[$I%] Removing: $LINE"
        fi
        COUNT=$[$COUNT+1]
        pkgrm "$LINE"
    done
    rm $FILE.clean
}

print_help() {
    echo "usage: ${SAFE_BUILD_COMMAND##*/} [options]"
    echo "options:"
    echo "  -b,   --backup              backup the newly built ports"
    echo "  -i,   --image               use CRUX offical iso"
    #echo "  -r,   --restore             restore backed up ports (reverse of -b)"
    echo "  -s,   --system              use working system ports"
    echo "  -c    --chroot              chroot back into the directory"
    echo "  -C    --clean               uninstall packages to a clean state"
    echo "  -u    --umount              unmount the chroot (shutdown)"
    echo "  -v,   --version             print version and exit"
    echo "  -h,   --help                print help and exit"
}

parse_options() {
	while [ "$1" ]; do
		case "$1" in
            -b|--backup)
				SAFE_BUILD_BACKUP_PORTS='yes' ;;
			-r|--restore)
                SAFE_BUILD_RESTORE_PORTS='yes' ;;
			-i|--image)
				SAFE_BUILD_SETUP_IMAGE='yes' ;;
			-s|--system)
				SAFE_BUILD_SETUP_SYSTEM='yes' ;;
			-u|--umount)
				SAFE_BUILD_SHUTDOWN_SYSTEM='yes' ;;
            -c|--chroot)
                SAFE_BUILD_SETUP_CHROOT='yes' ;;
			-C|--clean)
				CLEAN='yes' ;;
			-v|--version)
				echo "${SAFE_BUILD_COMMAND##*/} chroot wrapper $SAFE_BUILD_VERSION Copyright (c) 2008 by Danny Rawlins "
				exit 0 ;;
			-h|--help)
				print_help
				exit 0 ;;
			*)
				echo "${SAFE_BUILD_COMMAND##*/}: invalid option $1"
				exit 1 ;;
		esac
		shift
	done
}

main() {
   	if [ ! "$@" ]; then
		echo "${SAFE_BUILD_COMMAND##*/} make a chrooted enviroment to test your own ports."
		echo "Try ${SAFE_BUILD_COMMAND##*/} -h (or --help) for more information."
		exit 1
	fi

	parse_options "$@"

	if [ "$SAFE_BUILD_SETUP_IMAGE" = 'yes' ]; then
	   	setup_image
	
	elif [ "$SAFE_BUILD_SETUP_SYSTEM" = 'yes' ]; then
	   	setup_system
	fi

    if [ "$SAFE_BUILD_SETUP_CHROOT" = 'yes' ]; then
        start_chroot
    fi

    if [ "$CLEAN" = 'yes' ]; then
        clean
    fi

    if [ "$SAFE_BUILD_SHUTDOWN_SYSTEM" = 'yes' ]; then
        shutdown_umount
    fi

    if [ "$SAFE_BUILD_BACKUP_PORTS" = 'yes' ]; then
        backup_ports
        #echo 'not implemented for argument, currently automated'
    
    elif [ "$SAFE_BUILD_RESTORE_PORTS" = 'yes' ]; then
        #restore_ports
        echo 'not implemented for argument, currently automated'
    fi
	
	exit 0
}

#trap "interrupted" SIGHUP SIGINT SIGQUIT SIGTERM

export LC_ALL='POSIX'

readonly SAFE_BUILD_VERSION='@VERSION@'
readonly SAFE_BUILD_COMMAND="$0"
readonly SAFE_BUILD_ROOT="$PWD"
readonly SAFE_BUILD_DIR='/var/tmp/safe-build'
readonly SAFE_BUILD_TOOLCHAIN='binutils glibc gcc module-init-tools libstdc++-compat'

SAFE_BUILD_SETUP_SYSTEM='no'
SAFE_BUILD_SETUP_IMAGE='no'
SAFE_BUILD_SETUP_CHROOT='no'
SAFE_BUILD_SHUTDOWN_SYSTEM='no'
SAFE_BUILD_BACKUP_PORTS='no'
SAFE_BUILD_RESTORE_PORTS='no'
CLEAN='no'

SAFE_BUILD_CDIMAGE_PORTS_OPT='no'
SAFE_BUILD_CDIMAGE_PACKAGES_UPDATE_CORE='no'
SAFE_BUILD_CDIMAGE_PACKAGES_UPDATE_OPT='no'
SAFE_BUILD_CDIMAGE_PACKAGES_INSTALL_XORG='no'

[ -f '/etc/safe-build.conf' ] && . /etc/safe-build.conf

[ -z "${SAFE_BUILD_CD_MOUNT}" ] && SAFE_BUILD_CD_MOUNT='/mnt/cdrom'
[ -z "${SAFE_BUILD_CD_IMAGE}" ] && SAFE_BUILD_CD_IMAGE='/var/crux-2.3'
[ -z "${CRUX_VERSION}" ] && CRUX_VERSION='2.3'
[ -z "${SAFE_BUILD_CD_IMAGE}" ] && SAFE_BUILD_PORTS_TREE='core opt contrib xorg'

main "$@"

# vim: expandtab:ts=4:sw=4

# End of file.
