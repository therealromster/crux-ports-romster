# Description: Mozilla Network Security Services (NSS)
# URL: http://www.mozilla.org/projects/security/pki/nss/
# Maintainer: Danny Rawlins, monster dot romster at gmail dot com
# Packager: Fredrik Rinnestam, fredrik at crux dot nu
# Depends on: nspr-32 sqlite3-32

name=nss-32
version=3.15.1
release=1
source=(ftp://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/NSS_3_13_6_RTM/src/nss-$version.tar.gz
        nss-config.in nss.pc.in)

build() {
    cd nss-$version

	 # Do not override CC from commands.mk
	 # CCC is unused for g++ comment out
	 sed -i nss/coreconf/Linux.mk \
		 -e 's|^CC.*=.*gcc$|#&|' \
		 -e 's|^CCC.*=.*g++$|#&|'

    export NSPR_INCLUDE_DIR=/usr/include/nspr
    export NSPR_LIB_DIR=/usr/lib32
    export NSS_USE_SYSTEM_SQLITE=1
    export BUILD_OPT=1
    export XCFLAGS="${CFLAGS}"

    make -j1 -C nss all

    install -d $PKG/usr/{bin,lib32/pkgconfig}

	 local file

    for file in \
        libnss3.so libssl3.so libsmime3.so libsoftokn3.so \
        libsoftokn3.chk libnssckbi.so libfreebl3.so libfreebl3.chk \
        libcrmf.a libnssb.a libnssckfw.a libnssutil3.so libnssdbm3.so
    do
        install -m 0644 dist/*.OBJ/lib/$file $PKG/usr/lib32
    done

    chmod +x $PKG/usr/lib32/*.so

    # we have to provide our own nss-config, because xulrunner needs it
    install -m 0755 $SRC/nss-config.in $PKG/usr/bin/nss-config-32

    sed -i "s/@VERSION@/$version/" $PKG/usr/bin/nss-config-32

    NSS_LIBS=`$PKG/usr/bin/nss-config-32 --libs`
    NSS_CFLAGS=`$PKG/usr/bin/nss-config-32 --cflags`
    sed $SRC/nss.pc.in \
        -e "s,%libdir%,/usr/lib32," \
        -e "s,%prefix%,/usr," \
        -e "s,%exec_prefix%,/usr/bin," \
        -e "s,%includedir%,/usr/include/nss," \
        -e "s,%NSS_VERSION%,$version," \
        -e "s,%FULL_NSS_LIBS%,$NSS_LIBS," \
        -e "s,%FULL_NSS_CFLAGS%,$NSS_CFLAGS," > \
            $PKG/usr/lib32/pkgconfig/nss.pc
}
