# Description: The Mozilla Firefox browser 32bit flavour
# URL: http://www.mozilla.com/firefox/
# Maintainer: Danny Rawlins, monster dot romster at gmail dot com
# Packager: Fredrik Rinnestam, fredrik at crux dot nu
# Depends on: nss-32 libidl-32 gtk-32 python-32 alsa-lib-32 yasm mesa3d-32

name=firefox-32
version=25.0.1
release=1
source=(ftp://ftp.mozilla.org/pub/firefox/releases/$version/source/firefox-$version.source.tar.bz2
        mozconfig)

build() {
	sed -i -e 's:nss-config:nss-config-32:g' $(grep -lr 'nss-config' *)
	sed -i -e 's:nspr-config:nspr-config-32:g' $(grep -lr 'nspr-config' *)

	#sed -i -e 's/gre\.d/&-32/g' $(grep -lr 'gre\.d' *)
	
	#unset CCACHE_PREFIX
	#export MAKEFLAGS="-j $(/usr/bin/getconf _NPROCESSORS_ONLN)"

    #unset LD_PRELOAD
    export MOZ_CO_PROJECT=browser
    export BUILD_OFFICIAL=1
    export MOZILLA_OFFICIAL=1
    export MOZILLA_FIVE_HOME=/usr/lib32/firefox
    #export CC="gcc"
    #export CXX="g++"
    #export MOZ_MAKE_FLAGS="$(sed -e 's/.*\(-j *[0-9]\+\).*/\1/' <<< $MAKEFLAGS)"
	export MOZ_MAKE_FLAGS="$MAKEFLAGS"

    cd mozilla-release

	touch configure
    export CFLAGS="$CFLAGS -mno-avx"
 
    sed -e "s/#CFLAGS#/$CFLAGS/" $SRC/mozconfig > .mozconfig
    ./configure

	#mozilla sucks: BZ #824381
	mkdir $SRC/mozilla-release/js/src/.deps
	make

    install -d \
        $PKG$MOZILLA_FIVE_HOME \
        $PKG/usr/bin \
        $PKG/usr/share/idl/firefox

    cp -rL dist/bin/* $PKG$MOZILLA_FIVE_HOME
    ln -s /usr/lib32/firefox/firefox $PKG/usr/bin/firefox-32

    install -d $PKG/etc/ld.so.conf.d
    echo "/usr/lib32/firefox" > $PKG/etc/ld.so.conf.d/$name.conf

    # cleanup
	 find $PKG -type f -empty -delete

	 # desktop stuff
	#mkdir -p $PKG/usr/share/pixmaps
	#ln -s /usr/lib32/firefox/browser/chrome/browser/content/branding/icon48.png $PKG/usr/share/pixmaps/firefox_default48.png
	#install -D -m 0644 $SRC/firefox.desktop $PKG/usr/share/applications/firefox-32.desktop
}
