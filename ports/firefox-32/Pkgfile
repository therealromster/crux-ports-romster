# Description: The Mozilla Firefox browser 32bit flavour
# URL: http://www.mozilla.com/firefox/
# Maintainer: Danny Rawlins, monster dot romster at gmail dot com
# Packager: Fredrik Rinnestam, fredrik at crux dot nu
# Depends on: nss-32 libidl-32 gtk-32 python-32 alsa-lib-32 yasm mesa3d-32 libevent

name=firefox-32
version=26.0
release=1
source=(ftp://ftp.mozilla.org/pub/firefox/releases/$version/source/firefox-$version.source.tar.bz2
	mozconfig
	vendor.js
	firefox-install-dir.patch)

build() {
	cd mozilla-release

	# Adjust some hardwired paths for arch-dependent config files
	sed -i -e 's/gre\.d/&-32/g' $(grep -lr 'gre\.d' *)

	patch -p 1 -i $SRC/firefox-install-dir.patch
	export CFLAGS="$CFLAGS -mno-avx"

	sed \
		-e "s/#CFLAGS#/$CFLAGS/" \
		-e "s|#MAKEFLAGS#|$MAKEFLAGS|" \
		$SRC/mozconfig > .mozconfig
 
	make -f client.mk build
	make -f client.mk DESTDIR=$PKG install

	mv -v $PKG/usr/bin/firefox $PKG/usr/bin/firefox-32

	install -m 0644 -D $SRC/vendor.js \
		$PKG/usr/lib32/firefox/browser/defaults/preferences/vendor.js

	install -d $PKG/etc/ld.so.conf.d
	echo "/usr/lib32/firefox" > $PKG/etc/ld.so.conf.d/$name.conf

	rm -r $PKG/usr/share/idl $PKG/usr/include/firefox
}
